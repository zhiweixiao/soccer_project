---
title: "soccer_project"
author: "zhiwei xiao"
date: "7/9/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(DBI)
library(RSQLite)
library(tidyverse)
library(boot)
library(fitdistrplus)
library(qqplotr)
library(gamlss.dist)
library(extraDistr)
library(pscl)

temp <- dbConnect(SQLite(), "/Users/xiaozhiwei/Downloads/database.sqlite")
as.data.frame(dbListTables(temp))
match_data <- dbReadTable(temp,"Match")
team_id <- dbReadTable(temp,"Team")
league_id <- dbReadTable(temp,"League")

team_id <- team_id[,c("team_api_id", "team_long_name")]
match_data <- match_data[,1:11]
league_id <- league_id[,c(1,3)]
```



```{r}
match_data <- match_data %>% left_join(team_id, by = c("home_team_api_id" = "team_api_id"))
names(match_data)[12] = "home_team_name"
match_data <- match_data %>% left_join(team_id, by = c("away_team_api_id" = "team_api_id"))
names(match_data)[13] = "away_team_name"
match_data <- match_data %>% left_join(league_id, by = c("league_id" = "id"))
names(match_data)[14] = "league_name"

table(match_data$season)



cor(match_data$home_team_goal, match_data$away_team_goal)
```


```{r, message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
fit.in1 <- fitdist(match_data$home_team_goal, "norm")
fit.in2 <- fitdist(match_data$home_team_goal, "pois")
fit.in3 <- fitdist(match_data$home_team_goal, "nbinom")

denscomp(list(fit.in1,fit.in2,fit.in3),legendtext=c("Normal","pois","nbinom"))
qqcomp(list(fit.in1,fit.in2,fit.in3),legendtext=c("Normal","pois","nbinom"))
cdfcomp(list(fit.in1,fit.in2,fit.in3),legendtext=c("Normal","pois","nbinom"))
ppcomp(list(fit.in1,fit.in2,fit.in3),legendtext=c("Normal","pois","nbinom"))
```


```{r,message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
fit.in4 <- fitdist(match_data$away_team_goal, "norm")
fit.in5 <- fitdist(match_data$away_team_goal, "pois")
fit.in6 <- fitdist(match_data$away_team_goal, "nbinom")

denscomp(list(fit.in4,fit.in5,fit.in6),legendtext=c("Normal","pois","nbinom"))
qqcomp(list(fit.in4,fit.in5,fit.in6),legendtext=c("Normal","pois","nbinom"))
cdfcomp(list(fit.in4,fit.in5,fit.in6),legendtext=c("Normal","pois","nbinom"))
ppcomp(list(fit.in4,fit.in5,fit.in6),legendtext=c("Normal","pois","nbinom"))
```



```{r}
## data is not over-dispersed
r <- c(mean(match_data$home_team_goal), var(match_data$home_team_goal))
c(mean=r[1], var=r[2], ratio=r[2]/r[1])


fit = glm(home_team_goal ~ home_team_name + away_team_name, family="poisson", data = match_data)
fit.overdisp = glm(home_team_goal ~ home_team_name + away_team_name,family="quasipoisson",data = match_data)
summary(fit.overdisp)$dispersion # dispersion coefficient
pchisq(summary(fit.overdisp)$dispersion * fit$df.residual, fit$df.residual, lower = F)
#significance for overdispersion, if less than 0.05, over-dispersion is more appropriate
```


```{r,message=FALSE, warning=FALSE}
## should not use zero-inflated model
model1 <- glm(home_team_goal ~ home_team_name + away_team_name, family="poisson", data=match_data)

zobs <- match_data$home_team_goal == 0

zpoi <- exp(-exp(predict(model1)))

c(obs=mean(zobs), poi=mean(zpoi))
```


```{r}
## reject poisson model if p-value is smaller than 0.05/8
set.seed(200)
season_2008_2009_data = filter(match_data, season == "2008/2009")
table(season_2008_2009_data$home_team_goal)
season_2008_2009_probs = dpois(0:7, lambda = mean(season_2008_2009_data$home_team_goal))
season_2008_2009_divide = season_2008_2009_probs / sum(season_2008_2009_probs)
chisq.test(x = c(762,1090,829,418,157,48,17,5), p = season_2008_2009_divide) #pass

plotdist(season_2008_2009_data$home_team_goal, "pois", para=list(lambda = mean(season_2008_2009_data$home_team_goal)))


season_2009_2010_data = filter(match_data, season == "2009/2010")
table(season_2009_2010_data$home_team_goal)
season_2009_2010_probs = dpois(0:9, lambda = mean(season_2009_2010_data$home_team_goal))
season_2009_2010_divide = season_2009_2010_probs/sum(season_2009_2010_probs)
chisq.test(x = as.numeric(table(season_2009_2010_data$home_team_goal)), p = season_2009_2010_divide) # not pass

plotdist(season_2009_2010_data$home_team_goal, "pois", para=list(lambda = mean(season_2009_2010_data$home_team_goal)))


season_2010_2011_data = filter(match_data, season == "2010/2011")
table(season_2010_2011_data$home_team_goal)
season_2010_2011_probs = dpois(0:10, lambda = mean(season_2010_2011_data$home_team_goal))
season_2010_2011_divide = season_2010_2011_probs/sum(season_2010_2011_probs)
chisq.test(x = c(710,1082,812,408,162,60,18,5,1,1,1), p = season_2010_2011_divide) # not pass


season_2011_2012_data = filter(match_data, season == "2011/2012")
table(season_2011_2012_data$home_team_goal)
season_2011_2012_probs = dpois(0:8, lambda = mean(season_2011_2012_data$home_team_goal))
season_2011_2012_divide = season_2011_2012_probs/sum(season_2011_2012_probs)
chisq.test(x = c(752,1000,765,411,200,62,21,7,2), p = season_2011_2012_divide) # not pass


season_2012_2013_data = filter(match_data, season == "2012/2013")
table(season_2012_2013_data$home_team_goal)
season_2012_2013_probs = dpois(0:9, lambda = mean(season_2012_2013_data$home_team_goal))
season_2012_2013_divide = season_2012_2013_probs/sum(season_2012_2013_probs)
chisq.test(x = c(742,1033,812,406,187,57,19,2,1,1), p = season_2012_2013_divide) # pass



season_2013_2014_data = filter(match_data, season == "2013/2014")
dim(season_2013_2014_data)
table(season_2013_2014_data$home_team_goal)
season_2013_2014_probs = dpois(0:7, lambda = mean(season_2013_2014_data$home_team_goal))
season_2013_2014_divide = season_2013_2014_probs/sum(season_2013_2014_probs)
chisq.test(x = c(675,956,737,401,189,51,18,5), p = season_2013_2014_divide) # pass


season_2014_2015_data = filter(match_data, season == "2014/2015")
table(season_2014_2015_data$home_team_goal)
season_2014_2015_probs = dpois(0:9, lambda = mean(season_2014_2015_data$home_team_goal))
season_2014_2015_divide = season_2014_2015_probs/sum(season_2014_2015_probs)
chisq.test(x = c(767,1091,804,425,153,51,28,3,2,1), p = season_2014_2015_divide) # not pass

season_2015_2016_data = filter(match_data, season == "2015/2016")
table(season_2015_2016_data$home_team_goal)
season_2015_2016_probs = dpois(c(0,1,2,3,4,5,6,7,8,10), lambda = mean(season_2015_2016_data$home_team_goal))
season_2015_2016_divide = season_2015_2016_probs/sum(season_2015_2016_probs)
chisq.test(x = c(774,1059,808,429,149,75,26,4,1,1), p = season_2015_2016_divide) # not pass
```


```{r}
set.seed(200)
table(season_2008_2009_data$away_team_goal)
season_2008_2009_probs_away = dpois(0:7, lambda = mean(season_2008_2009_data$away_team_goal))
season_2008_2009_divide_away = season_2008_2009_probs_away / sum(season_2008_2009_probs_away)
chisq.test(x = c(1178,1141,636,266,78,21,5,1), p = season_2008_2009_divide_away) # pass


table(season_2009_2010_data$away_team_goal)
season_2009_2010_probs_away = dpois(0:7, lambda = mean(season_2009_2010_data$away_team_goal))
season_2009_2010_divide_away = season_2009_2010_probs_away/sum(season_2009_2010_probs_away)
chisq.test(x = c(1126,1107,620,248,90,32,6,1), p = season_2009_2010_divide_away) # not pass


table(season_2010_2011_data$away_team_goal)
season_2010_2011_probs_away = dpois(0:8, lambda = mean(season_2010_2011_data$away_team_goal))
season_2010_2011_divide_away = season_2010_2011_probs_away/sum(season_2010_2011_probs_away)
chisq.test(x = c(1111,1129,646,258,88,19,6,1,2), p = season_2010_2011_divide_away) # not pass


table(season_2011_2012_data$away_team_goal)
season_2011_2012_probs_away = dpois(0:7, lambda = mean(season_2011_2012_data$away_team_goal))
season_2011_2012_divide_away = season_2011_2012_probs_away/sum(season_2011_2012_probs_away)
chisq.test(x = c(1107,1107,626,252,86,29,12,1), p = season_2011_2012_divide_away) # not pass



table(season_2012_2013_data$away_team_goal)
season_2012_2013_probs_away = dpois(0:7, lambda = mean(season_2012_2013_data$away_team_goal))
season_2012_2013_divide_away = season_2012_2013_probs_away/sum(season_2012_2013_probs_away)
chisq.test(x = c(1017,1133,678,287,103,29,12,1), p = season_2012_2013_divide_away) # not pass



table(season_2013_2014_data$away_team_goal)
season_2013_2014_probs_away = dpois(0:7, lambda = mean(season_2013_2014_data$away_team_goal))
season_2013_2014_divide_away = season_2013_2014_probs_away/sum(season_2013_2014_probs_away)
chisq.test(x = c(994,1035,611,270,84,31,5,2), p = season_2013_2014_divide_away) # not pass


table(season_2014_2015_data$away_team_goal)
season_2014_2015_probs_away = dpois(0:8, lambda = mean(season_2014_2015_data$away_team_goal))
season_2014_2015_divide_away = season_2014_2015_probs_away/sum(season_2014_2015_probs_away)
chisq.test(x = c(1127,1135,666,272,84,29,8,2,2), p = season_2014_2015_divide_away) # not pass


table(season_2015_2016_data$away_team_goal)
season_2015_2016_probs_away = dpois(0:9, lambda = mean(season_2015_2016_data$away_team_goal))
season_2015_2016_divide_away = season_2015_2016_probs_away/sum(season_2015_2016_probs_away)
chisq.test(x = c(1027,1202,663,292,105,25,9,1,1,1), p = season_2015_2016_divide_away) # not pass
```


```{r}
n_distinct(match_data$home_team_name)
n_distinct(match_data$away_team_name)
Belgium_data = subset(match_data, league_name == "Belgium Jupiler League" & season == "2015/2016")
England_data = subset(match_data, league_name == "England Premier League"& season == "2015/2016")
France_data = subset(match_data, league_name == "France Ligue 1" & season == "2015/2016")
Germany_data = subset(match_data, league_name == "Germany 1. Bundesliga" & season == "2015/2016")
Italy_data = subset(match_data, league_name == "Italy Serie A" & season == "2015/2016")
Netherland_data = subset(match_data, league_name == "Netherlands Eredivisie" & season == "2015/2016")
Poland_data = subset(match_data, league_name == "Poland Ekstraklasa" & season == "2015/2016")
Portugal_data = subset(match_data, league_name == "Portugal Liga ZON Sagres" & season == "2015/2016")
Scotland_data = subset(match_data, league_name == "Scotland Premier League" & season == "2015/2016")
Spain_data = subset(match_data, league_name == "Spain LIGA BBVA" & season == "2015/2016")
Switzerland_data = subset(match_data, league_name == "Switzerland Super League" & season == "2015/2016")
```


```{r, warning=FALSE}
a = Belgium_data$home_team_goal
Belgium_data_fit_poisson = fitdistr(a, densfun = "poisson")
Belgium_data_fit_poisson$loglik # pick
Belgium_data_fit_nb = fitdistr(a, densfun = "Negative Binomial")
Belgium_data_fit_nb$loglik
Belgium_poisson_model <- glm(home_team_goal ~ home_team_name + away_team_name, family = "poisson", data = Belgium_data)
summary(Belgium_poisson_model)

b = England_data$home_team_goal
England_data_fit_poisson = fitdistr(b, densfun = "poisson")
England_data_fit_poisson$loglik
England_data_fit_nb = fitdistr(b, densfun = "Negative Binomial")
England_data_fit_nb$loglik
England_data_fit_zip <- fitdist(b, distr = 'zip',start = list(lambda=mean(b),pi=sum(b == 0)/length(b)))
England_data_fit_zip$loglik # pick
England_zero_inflated_poisson_model <- zeroinfl(home_team_goal ~ home_team_name + away_team_name, data = England_data)
summary(England_zero_inflated_poisson_model)


c = France_data$home_team_goal
France_data_fit_poisson = fitdistr(c, densfun = "poisson")
France_data_fit_poisson$loglik
France_data_fit_nb = fitdistr(c, densfun = "Negative Binomial")
France_data_fit_nb$loglik # pick
France_data_fit_zip <- fitdist(c, distr = 'zip',start = list(lambda=mean(c),pi=sum(c == 0)/length(c)))
France_data_fit_zip$loglik
France_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = France_data)
summary(France_negative_binomial_model)


d = Germany_data$home_team_goal
Germany_data_fit_poisson = fitdistr(d, densfun = "poisson")
Germany_data_fit_poisson$loglik
Germany_data_fit_nb = fitdistr(d, densfun = "Negative Binomial")
Germany_data_fit_nb$loglik # pick
Germany_data_fit_zip <- fitdist(d, distr = 'zip',start = list(lambda=mean(d),pi=sum(d == 0)/length(d)))
Germany_data_fit_zip$loglik
Germany_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = Germany_data)
summary(Germany_negative_binomial_model)


e = Italy_data$home_team_goal
Italy_data_fit_poisson = fitdistr(e, densfun = "poisson")
Italy_data_fit_poisson$loglik
Italy_data_fit_nb = fitdistr(e, densfun = "Negative Binomial")
Italy_data_fit_nb$loglik
Italy_data_fit_zip <- fitdist(e, distr = 'zip',start = list(lambda=mean(e),pi=sum(e == 0)/length(e)))
Italy_data_fit_zip$loglik # pick
Italy_zero_inflated_poisson_model <- zeroinfl(home_team_goal ~ home_team_name + away_team_name, data = Italy_data)
summary(Italy_zero_inflated_poisson_model)




f = Netherland_data$home_team_goal
Netherland_data_fit_poisson = fitdistr(f, densfun = "poisson")
Netherland_data_fit_poisson$loglik
Netherland_data_fit_nb = fitdistr(f, densfun = "Negative Binomial")
Netherland_data_fit_nb$loglik
Netherland_data_fit_zip <- fitdist(f, distr = 'zip',start = list(lambda=mean(f),pi=sum(f == 0)/length(f)))
Netherland_data_fit_zip$loglik # pick
Netherland_zero_inflated_poisson_model <- zeroinfl(home_team_goal ~ home_team_name + away_team_name, data = Netherland_data)



g = Poland_data$home_team_goal
Poland_data_fit_poisson = fitdistr(g, densfun = "poisson")
Poland_data_fit_poisson$loglik
Poland_data_fit_nb = fitdistr(g, densfun = "Negative Binomial")
Poland_data_fit_nb$loglik # pick
Poland_data_fit_zip <- fitdist(g, distr = 'zip',start = list(lambda=mean(g),pi=sum(g == 0)/length(g)))
Poland_data_fit_zip$loglik
Poland_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = Poland_data)


h = Portugal_data$home_team_goal
Portugal_data_fit_poisson = fitdistr(h, densfun = "poisson")
Portugal_data_fit_poisson$loglik
Portugal_data_fit_nb = fitdistr(h, densfun = "Negative Binomial")
Portugal_data_fit_nb$loglik # pick
Portugal_data_fit_zip <- fitdist(h, distr = 'zip',start = list(lambda=mean(h),pi=sum(h == 0)/length(h)))
Portugal_data_fit_zip$loglik
Portugal_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = Portugal_data)


i = Scotland_data$home_team_goal
Scotland_data_fit_poisson = fitdistr(i, densfun = "poisson")
Scotland_data_fit_poisson$loglik
Scotland_data_fit_nb = fitdistr(i, densfun = "Negative Binomial")
Scotland_data_fit_nb$loglik # pick
Scotland_data_fit_zip <- fitdist(i, distr = 'zip',start = list(lambda=mean(i),pi=sum(i == 0)/length(i)))
Scotland_data_fit_zip$loglik
Scotland_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = Scotland_data)



j = Spain_data$home_team_goal
Spain_data_fit_poisson = fitdistr(j, densfun = "poisson")
Spain_data_fit_poisson$loglik
Spain_data_fit_nb = fitdistr(j, densfun = "Negative Binomial")
Spain_data_fit_nb$loglik # pick
Spain_data_fit_zip <- fitdist(j, distr = 'zip',start = list(lambda=mean(j),pi=sum(j == 0)/length(j)))
Spain_data_fit_zip$loglik
Spain_negative_binomial_model <- glm.nb(home_team_goal ~ home_team_name + away_team_name, data = Spain_data)


k = Switzerland_data$home_team_goal
Switzerland_data_fit_poisson = fitdistr(k, densfun = "poisson")
Switzerland_data_fit_poisson$loglik
Switzerland_data_fit_nb = fitdistr(k, densfun = "Negative Binomial")
Switzerland_data_fit_nb$loglik
Switzerland_data_fit_zip <- fitdist(k, distr = 'zip',start = list(lambda=mean(k),pi=sum(k == 0)/length(k)))
Switzerland_data_fit_zip$loglik # pick
Switzerland_zero_inflated_poisson_model <- zeroinfl(home_team_goal ~ home_team_name + away_team_name, data = Switzerland_data)




## generate simulated zip data, and then fit zinb. done. not ideal
```







